# v1.1.4

Release date: 2026-01-16

## Features

### New `setup-tools` Command
- Added interactive menu-based command to install companion tools for Claude Code
- Currently supports CCometixLine installation with automatic statusline merging
- Installation flow: `npm install -g @cometix/ccline` → `ccline install` → statusline integration
- Features:
  - Interactive checkbox selection via `@inquirer/prompts`
  - `--list` flag to view available tools without installing
  - Automatic detection of already-installed tools with reinstall prompt
  - Clear progress messages and error handling with manual fallback suggestions
  - Restart warning after installation

**Usage:**
```bash
oh-my-claude setup-tools         # Interactive menu
oh-my-claude setup-tools --list  # List available tools
```

### New `config` Command
- Added CLI command to manage oh-my-claude configuration
- Supports get, set, unset, and list operations
- Configuration stored in `~/.claude/oh-my-claude.json`
- Available settings: `debugTaskTracker`, `debugHooks`

**Usage:**
```bash
oh-my-claude config --list           # Show all config
oh-my-claude config --get <key>      # Get a value
oh-my-claude config --set key=value  # Set a value
oh-my-claude config --unset <key>    # Remove a value
```

### Enhanced StatusLine with Colors & Spinners
- Added ANSI color support for visual distinction
  - Cyan for MCP agents (Oracle, Librarian, etc.)
  - Yellow for Task agents (@Scout, etc.)
  - Red for fallback mode
  - Green for ready indicator and high capacity
- Added animated braille spinners for active tasks (`⠋⠙⠹⠸⠼⠴⠦⠧⠇⠏`)
- Added mode tracking (mcp vs fallback) in status file
- Provider capacity now shows available slots with color coding:
  - Green: 70%+ available
  - Yellow: 30-70% available
  - Red: <30% available

**Example outputs:**
| State | Output |
|-------|--------|
| Idle | `omc ● ready \| DS: 10 ZP: 10 MM: 5` |
| Active | `omc [⠙ Oracle: 32s] \| DS: 9 ZP: 10` |

### New `execute_agent` Blocking MCP Tool
- Added new MCP tool for synchronous agent execution without polling clutter
- Single blocking call that waits for completion and returns result directly
- Eliminates repetitive `poll_task` calls that cluttered conversation output
- Supports all MCP agents: oracle, librarian, explore, frontend-ui-ux, document-writer
- Features:
  - Configurable timeout (default: 5 minutes)
  - Graceful timeout handling (returns task_id for manual polling if needed)
  - Proper fallback handling when provider API key not configured
- Updated agent commands (`/omc-oracle`, `/omc-librarian`, `/omc-explore`) to use new blocking pattern

**Before (cluttered):**
```
launch_background_task → poll_task → poll_task → poll_task → result
```

**After (clean):**
```
execute_agent → result (single call)
```

### Beta Channel Support
- Added `update --beta` to install from GitHub dev branch without npm publishing
- Added `update --beta --ref=<commit>` to install specific commit/tag
- Running `update` (without --beta) switches beta users back to stable
- Beta installations tracked via `~/.claude/oh-my-claude/.beta-channel` marker file
- Doctor command now shows version and channel info (stable/beta)

**Commands:**
```bash
oh-my-claude update --beta              # Install latest dev branch
oh-my-claude update --beta --ref=abc123 # Install specific commit
oh-my-claude update                     # Switch back to stable
oh-my-claude doctor                     # Shows channel info
```

## Fixed

### Per-Session Status Tracking
- **BREAKING**: Status files now stored per-session at `~/.claude/oh-my-claude/sessions/{session_id}/`
- Each Claude Code instance gets isolated token counters (DS/ZP/MM no longer shared)
- New `src/statusline/session.ts` module for session ID management
- Automatic cleanup of stale session directories (>1 hour old)

### CCometixLine Integration
- Fixed `ccline install` command (doesn't exist) → now uses `ccline --init`
- Fixed "Reinstall? No" actually removing CCometixLine → now keeps existing config
- Setup-tools now creates proper wrapper script combining ccline + oh-my-claude statuslines
- Wrapper outputs both statuslines (ccline first, omc second)

### StatusLine Provider Display for MCP Agents
- Added `provider` field to track which provider (deepseek/zhipu/minimax) MCP agents use
- Statusline now shows provider abbreviation: `[⠙ Oracle (DS): 1m]`
- Task tool agents show model (S/O/H), MCP agents show provider (DS/ZP/MM)

### /omc-plan Command
- Fixed `/omc-plan` to properly invoke Prometheus agent instead of just toggling plan mode
- Now spawns Prometheus via `Task(subagent_type="Plan")` to actively:
  - Interview user about the task
  - Explore codebase for context
  - Create structured plans in `.sisyphus/plans/`
  - Hand off to Sisyphus for execution via `/omc-start-work`

### Task Agent Tracking in StatusLine
- Fixed Task tool agents (like @Plan, @Scout) not appearing in statusline
- Added validation for `task-agents.json` to handle corrupted data
- Added model info display showing which Claude model is being used (S=Sonnet, O=Opus, H=Haiku)
- Example: `omc [⠙ @Plan: 12s (S)]` shows Plan agent running with Sonnet model

### Task Tracker Hook Improvements
- Added support for both `tool` and `tool_name` input fields (official API compatibility)
- Added support for both `tool_output` and `tool_response` fields
- Added `hook_event_name` detection for PreToolUse vs PostToolUse
- Debug setting now configurable via `oh-my-claude config --set debugTaskTracker=true`

### New `cleanup` Command
- Added CLI command to clean up stale session data and temporary files
- Cleans session directories for PIDs that are no longer running
- Options:
  - `--dry-run`: Preview what would be cleaned without deleting
  - `--force`: Clean all sessions including recent/active ones
- Also cleans PPID tracking file and debug logs

**Usage:**
```bash
oh-my-claude cleanup          # Clean stale sessions
oh-my-claude cleanup --dry-run  # Preview cleanup
oh-my-claude cleanup --force    # Clean everything
```

### Process Tree Session Discovery
- Session IDs now based on Claude Code's PID (`pid-{pid}` format)
- Walks up process tree to find "claude" process (handles nested shell spawns)
- Falls back to PPID file for MCP server discovery
- All hooks, statusline, and MCP server now share the same session per terminal
- Automatic cleanup of sessions for terminated processes

## Files Changed
- `src/cli.ts` - Added setup-tools command, config command, --beta/--ref options, cleanup command
- `src/statusline/formatter.ts` - Added colors, spinners, mode tracking, model/provider abbreviations
- `src/statusline/statusline.ts` - Use session-specific status file path
- `src/statusline/session.ts` - PPID-based session discovery, writeCurrentPPID export
- `src/mcp/background-agent-server/task-manager.ts` - Added mode/provider fields, session-specific paths, `waitForTaskCompletion()` function
- `src/mcp/background-agent-server/server.ts` - Added `execute_agent` tool and handler
- `src/hooks/task-tracker.ts` - Added model tracking, PPID advertisement, session-specific paths
- `src/commands/omc-plan.md` - Rewrote to invoke Prometheus agent properly
- `src/commands/omc-oracle.md` - Updated to use `execute_agent` blocking pattern
- `src/commands/omc-librarian.md` - Updated to use `execute_agent` blocking pattern
- `src/commands/omc-explore.md` - Updated to use `execute_agent` blocking pattern
- `src/installer/beta-channel.ts` - New file for beta channel utilities
- `src/config/schema.ts` - Added debugTaskTracker and debugHooks settings
- `package.json` - Added @inquirer/prompts dependency
