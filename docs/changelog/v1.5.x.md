# v1.5.x Changelog

> **Note:** v1.5.x features after beta.12 were promoted to v2.0.0. See [v2.0.x changelog](v2.0.x.md).

## v1.5.0-beta.12 - 2026-02-13

### Added

- **Provider Usage Statusline Segment**: New `usage` segment displays provider balance/quota on a second statusline row. DeepSeek shows CNY balance (`DS:¥1992`), ZhiPu shows token usage % and remaining calls (`ZP:8%/983c`), Kimi/MiniMax show local request counts from proxy (`KM:12req`). Per-provider color coding (green/yellow/red) based on balance thresholds. 60-second file cache at `~/.config/oh-my-claude/usage-cache.json` prevents excessive API calls.

- **Proxy `/usage` Endpoint**: New `GET /usage` control API endpoint returns per-provider request counts tracked in-memory. Increments on every `handleSwitched()` and `handleDirectiveRoute()` call. Resets on proxy restart.

- **Multi-Line Statusline Support**: `renderSegments()` now supports segments with `metadata.newLine = "true"`, rendering them on a separate output line below the main statusline.

- **Sisyphus Orchestration Routing Framework**: Added Step 1.5 decision table to Sisyphus agent prompt. Maps trigger patterns (multi-domain work, research, batch fixes, architecture decisions) to specific tools (`/omc-team`, `/omc-plan`, `/omc-ulw`, `/omc-switch`). Prevents Sisyphus from handling complex tasks alone when orchestration tools would be more effective.

### New Files

- `src/statusline/segments/usage.ts` — Usage segment with DeepSeek balance API, ZhiPu quota API, proxy local usage, and file-based caching

---

## v1.5.0-beta.11 - 2026-02-12

### Added

- **Per-Session Proxy Isolation**: Each `oh-my-claude cc` instance gets a unique session ID embedded in `ANTHROPIC_BASE_URL` (`/s/{sessionId}/...`). Multiple Claude Code instances can now switch providers independently without interfering with each other. In-memory session state with 2-hour TTL and automatic cleanup.

- **Route Directives for Team Provider Routing**: Embed `[omc-route:provider/model]` in agent system prompts to auto-route requests to specific providers without `switch_model`. The proxy extracts the directive, routes the request, and skips counter decrement — zero side effects on session/global state. Supports both string and content-block system prompt formats.

- **Session-Aware MCP Server**: `switch_model`, `switch_status`, and `switch_revert` MCP tools now extract session ID from `ANTHROPIC_BASE_URL` and use the control API with `?session=` parameter for accurate session-scoped operations. Falls back to global file state when no session or control API is unreachable.

- **Session-Aware StatusLine**: Proxy statusline segment now queries the control API with session ID for accurate per-instance status display instead of reading global file state.

### Changed

- **Proxy 4-Priority Routing**: Request routing now follows: (1) Route directive → (2) Session state → (3) Global file state → (4) Passthrough to Anthropic. Previous 2-priority system only had global state and passthrough.

- **`cc` Session Feature Detection**: `cc.ts` checks for `activeSessions` field in `/health` response to detect session support. Falls back to old URL format (no session prefix) if proxy is outdated, preventing the "model not found" error.

- **Team Templates Updated**: All team templates (`fullstack.md`, `research.md`, `visual.md`, `docs.md`, `review.md`) and `/omc-team` command updated with `[omc-route:provider/model]` directive markers for automatic provider routing.

### New Files

- `src/proxy/session.ts` — In-memory session state map (parseSessionFromPath, read/write/reset/decrement/cleanup)
- `src/proxy/route-directive.ts` — Route directive extraction from system prompts (`[omc-route:provider/model]`)

---

## v1.5.0-beta.10 - 2026-02-12

### Fixed

- **Proxy SSE Timeout**: Bun.serve's default `idleTimeout` (10s) caused premature disconnects during long SSE streaming responses. Set to `idleTimeout: 255` (maximum allowed by Bun) to support 30-120+ second API calls.

- **Memory FTS5 Returns 0 Results**: Multi-token queries like `"kimi navigator agent teams"` returned nothing because FTS5 uses implicit AND (all tokens must appear in the same chunk). `sanitizeFTSQuery()` now joins tokens with `OR` so any matching term produces results.

- **Memory Tags Ignored in FTS/Hybrid Search**: The `tags` filter parameter was only used in the legacy tier. FTS5 and hybrid tiers now augment the query with tag values for better matching.

- **`oh-my-claude cc -- --resume` Error**: CLI rejected extra arguments with "too many arguments for 'cc'". Added variadic `[claude-args...]` argument with `passThroughOptions(true)` and `enablePositionalOptions(true)` for proper flag forwarding to `claude`.

### Changed

- **Proxy Thinking Block Sanitization (3-Phase)**: Reworked from 2-phase to 3-phase sanitization to support GLM-5 and MiniMax M2.5 thinking capabilities:
  1. Always strip thinking content blocks from history (cross-provider signature safety)
  2. Strip top-level `thinking` config only for non-compatible providers (ZhiPu, MiniMax, Kimi keep it)
  3. Full content type sanitization only for non-compatible providers

- **Proxy Log Noise Reduction**: `/v1/messages/count_tokens` and other high-frequency endpoints now suppressed unless `OMC_PROXY_DEBUG=1` is set. Thinking block strip logs also moved to debug-only.

- **`/omc-ulw` Permission Instructions**: No longer blocks waiting for confirmation. Recommends `allowEdits` mode (Tab key) as minimum permission level for uninterrupted Ultrawork execution.

- **`/omc-team` Template Path**: Changed to reference installed path (`~/.claude/oh-my-claude/teams/`) with fallback to `src/teams/` for development.

### Added

- **Team Template Installation**: Installer now copies team templates (`fullstack.md`, `research.md`, `visual.md`, `docs.md`, `review.md`) to `~/.claude/oh-my-claude/teams/`. Uninstall command list updated to include all newer commands.

---

## v1.5.0-beta.9 - 2026-02-10

### Added

- **`cc` Command — One-Step Claude Code Launch**: `oh-my-claude cc` wraps proxy startup + `claude` launch into a single command. Auto-starts the proxy daemon if not running, injects `ANTHROPIC_BASE_URL` into the child process, and forwards all args (e.g., `oh-my-claude cc -- --resume`).

- **`cc --provider` Direct Provider Mode**: Launch Claude Code connected directly to an external provider without a proxy. Shortcuts: `ds` (DeepSeek), `zp` (ZhiPu), `mm` (MiniMax), `km` (Kimi), `or` (OpenRouter). Sets `ANTHROPIC_BASE_URL` and `ANTHROPIC_API_KEY` in the child process env.
  ```bash
  oh-my-claude cc -p ds         # DeepSeek
  oh-my-claude cc -p km         # Kimi
  oh-my-claude cc -p or         # OpenRouter
  ```

### Changed

- **CLI Modular Refactor**: Monolithic `src/cli.ts` (3230 lines) refactored into a 51-line orchestrator + 12 per-command modules in `src/cli/commands/` + shared utilities in `src/cli/utils/`. Eliminates 24 duplicate color definitions, 3 duplicate health check implementations, and 7+ inline path computations.

### Improved

- **Proxy SSE Log**: Now shows both provider and target model — `"kimi-k2.5" → "claude-opus-4-6"` instead of just `→ "claude-opus-4-6"`. Removed per-event log spam.

- **Proxy Sanitize Log**: Reduced from 4 lines per request to 1 line only when something is actually stripped. Silent when nothing to strip.

- **Kimi Full Compatibility**: Added Kimi to `FULL_COMPATIBILITY_PROVIDERS`, skipping unnecessary general sanitization (same as ZhiPu/MiniMax).

---

## v1.5.0-beta.8 - 2026-02-10

### Added

- **Memory Timeline (Auto-Context)**: Auto-maintained `TIMELINE.md` acts as a chronological table of contents for all memories. Injected into agent context on every prompt via the memory-awareness hook, giving the agent continuous cross-session awareness without needing to call `recall()` first. Regenerated after every memory mutation (remember, forget, compact, clear, summarize) and on indexer startup. Time-period grouping with auto-scaling (Today/Yesterday full detail, This Week capped at 10, older months collapsed).

- **Kimi Provider**: Added Kimi (api.kimi.com/coding) as a built-in proxy provider with `KIMI_API_KEY` env var. Shortcut: `/omc-switch km` for kimi-k2.5.

### Fixed

- **Proxy: "Invalid signature in thinking block" Error**: `switchOccurredInSession` flag in proxy handler was volatile (lost on proxy restart), causing non-Anthropic thinking blocks to slip through to the Anthropic API after a restart. Fix: always strip thinking blocks from passthrough requests regardless of session state. Only re-serializes the body when blocks are actually found (zero overhead for requests without thinking blocks).

### Changed

- **`summarize_memories`: Auto-delete originals**: `archiveOriginals` now defaults to `true`. After saving a consolidated summary, the original memories are deleted automatically. Pass `archiveOriginals: false` to keep them.

- **`summarize_memories`: Keyword-rich tags for retrieval**: The AI prompt now extracts all useful keywords from original memories (technical terms, feature names, patterns, tools, etc.) as tags. Tags are passed from analyze to execute mode instead of being hardcoded to `["summary", "timeline"]`. Aims for 8-20 specific, searchable tags per summary.

---

## v1.5.0-beta.6 - 2026-02-06

### Fixed

- **Hook Duplication on Reinstall (Windows)**: `addHook()` in settings-merger now strips quotes before comparing script filenames, preventing duplicate hooks when path quoting style differs between installs (e.g., `hooks/file.js` vs `hooks\\file.js"`)

---

## v1.5.0-beta.5 - 2026-02-06

### Changed

- **Command Namespace Reorganization**:
  - Memory commands moved to `omc-mem-*` namespace for clarity:
    - `/omc-compact` → `/omc-mem-compact`
    - `/omc-clear` → `/omc-mem-clear`
    - `/omc-summary` → `/omc-mem-summary`
  - Ultrawork mode moved to consistent namespace:
    - `/ulw` → `/omc-ulw`
  - Removes `modeCommands` category — all commands now under `agentCommands`

- **`/omc-ulw` Auto-Accept Permissions**: Ultrawork mode now prompts user to enable auto-accept permissions (Shift+Tab or `--dangerously-skip-permissions`) before starting, so it can work uninterrupted until the task is complete

- **Installer Deprecated Command Cleanup**: `install` and `update` now remove old command files (`omc-compact.md`, `omc-clear.md`, `omc-summary.md`, `ulw.md`) from `~/.claude/commands/` to prevent duplicates after rename

---

## v1.5.0-beta.4 - 2026-02-06

### Added

- **`/omc-mem-clear` Slash Command**: AI-powered selective memory cleanup
  - Analyzes all memories using AI (ZhiPu -> MiniMax -> DeepSeek) to identify outdated, redundant, or irrelevant ones
  - Candidates shown with confidence level (high/medium) and deletion reason
  - User confirms which to delete: all, high-confidence only, specific numbers, or cancel
  - Conservative by default — keeps architectural decisions, lessons learned, and important patterns

- **`/omc-mem-summary` Slash Command**: Date-range memory consolidation into timeline
  - Collects memories from a configurable date range (default: 7 days)
  - AI creates a chronological timeline summary with date-based sections
  - Preview before saving; option to archive (delete) original memories after summarization
  - Supports `days`, `scope` arguments (e.g., `/omc-mem-summary 14 project`)

- **`clear_memories` MCP Tool**: Backend for `/omc-mem-clear`
  - `analyze` mode: AI reviews memories, returns deletion candidates with reasons and confidence
  - `execute` mode: Deletes confirmed memory IDs with index cleanup

- **`summarize_memories` MCP Tool**: Backend for `/omc-mem-summary`
  - `analyze` mode: Collects memories in date range, AI generates timeline summary
  - `execute` mode: Saves summary as new memory, optionally archives originals
  - Supports explicit `after`/`before` dates or relative `days` parameter

---

## v1.5.0-beta.3 - 2026-02-06

### Added

- **`doctor --fix-mem` Command**: Automated memory system repair
  - Step 1: Locates and copies `sql-wasm.wasm` to install directory
  - Step 2: Rebuilds SQLite index from markdown files (creates `index.db`)
  - Step 3: Tests embedding provider connectivity
  - Reports how many issues were fixed

- **WASM Runtime Check in Doctor**: Doctor now checks for `sql-wasm.wasm` presence
  - Default mode: `✓ WASM runtime` / `✗ WASM runtime missing` with fix hint
  - Detail mode: file size, path, and fix instructions

### Fixed

- **WASM File Not Deployed (Root Cause of Embedding Not Working)**:
  - `build:mcp` script used `cp node_modules/...` which fails silently under Bun (global cache, no node_modules)
  - Replaced with `scripts/copy-wasm.ts` that resolves WASM via multiple strategies (node_modules, require.resolve, import.meta.resolve)
  - The build script now **fails explicitly** if WASM cannot be found, instead of silently skipping
  - After `bun install && bun run build:mcp`, `dist/mcp/sql-wasm.wasm` is always present
  - `oh-my-claude install` then copies it to `~/.claude/oh-my-claude/mcp/` (installer was already correct)

- **Exported `findWasmPath()` Utility**: Public function for WASM file resolution, used by both indexer and doctor

### Changed

- **Doctor action is now async**: Required for `--fix-mem` index rebuild which uses async indexer APIs

---

## v1.5.0-beta.2 - 2026-02-06

### Added

- **Doctor Memory Health Check**: `oh-my-claude doctor` now includes a Memory System section
  - Default mode: memory count, SQLite index status, embedding provider, active search tier
  - Detail mode (`--detail`): storage breakdown (global/project), index.db size, embedding env vars, API connectivity test, search tier explanation with upgrade path
  - Connectivity test for custom embedding provider (curl to Ollama/vLLM endpoint)

---

## v1.5.0-beta.1 - 2026-02-05

### Added

- **Custom OpenAI-Compatible Embedding Provider**: Use any OpenAI-compatible embedding endpoint (Ollama, vLLM, LM Studio, etc.)
  - Activate via `EMBEDDING_API_BASE` environment variable
  - Optional env vars: `EMBEDDING_MODEL`, `EMBEDDING_API_KEY`, `EMBEDDING_DIMENSIONS`
  - Automatic dimension auto-detection via probe API call (skipped if `EMBEDDING_DIMENSIONS` set)
  - Keyless auth support for local endpoints (no Authorization header when `EMBEDDING_API_KEY` is unset)

### Changed

- **Explicit Embedding Provider Selection**: Provider is now explicitly selected in config — no more implicit cascade
  - Config `embedding.provider`: `"custom"` | `"zhipu"` | `"openrouter"` | `"none"` (default: `"custom"`)
  - If selected provider can't initialize, degrades to FTS5-only (Tier 2) — no silent fallback to another provider
  - Clear stderr logging: shows exactly which provider is active or why it failed
  - Removed `fallback` field from embedding config (was `"openrouter"` default)
- **`resolveEmbeddingProvider()` is now async** — required for custom provider dimension auto-detection
- **MCP server passes config to embedding resolver** — was previously called with no arguments (bug fix)

### Tested

- Ollama `qwen3-embedding` (4096d) via custom provider — working
- ZhiPu `embedding-3` (1024d) via explicit config — working
- No-env-var degradation to Tier 2 — clear error messaging

---

## v1.5.0-beta.0 - 2026-02-05

### Added

- **Semantic Memory Search (Three-Tier Architecture)**: Complete rewrite of memory search with automatic degradation
  - **Tier 1 (Hybrid)**: FTS5 BM25 keyword search + vector cosine similarity, merged with configurable weights (default: 0.7 vector, 0.3 text)
  - **Tier 2 (FTS5)**: BM25 keyword search via SQLite FTS5 virtual tables — a massive upgrade over legacy `string.includes()` matching
  - **Tier 3 (Legacy)**: Fallback to in-memory token matching when SQLite is unavailable
  - Automatic tier detection: embeddings available → Tier 1, indexer ready → Tier 2, otherwise → Tier 3

- **SQLite Index Engine (`src/memory/indexer.ts`)**:
  - Pure WASM SQLite via `sql.js-fts5` (zero native dependencies, cross-platform)
  - FTS5 full-text search with BM25 ranking and content table + trigger pattern
  - SHA-256 hash-based change detection (skip unchanged files during sync)
  - Markdown chunking: ~400 token target, 80 token overlap, heading-aware splitting
  - Lazy initialization (database created on first use)
  - Index is derivative — can be deleted and rebuilt from markdown files at any time

- **Embedding Provider (`src/memory/embeddings.ts`)**:
  - Explicit provider selection: `"custom"` | `"zhipu"` | `"openrouter"` | `"none"`
  - Custom provider for any OpenAI-compatible endpoint (Ollama, vLLM, LM Studio) via `EMBEDDING_API_BASE`
  - ZhiPu `embedding-3` (1024 dims), OpenRouter `text-embedding-3-small` (1536 dims)
  - Dimension auto-detection for custom provider via probe API call
  - OpenAI-compatible embeddings API format for all providers
  - Batch embedding (up to 20 texts per API call)
  - Embedding cache in SQLite to avoid re-embedding unchanged chunks

- **Deduplication System (`src/memory/dedup.ts`)**:
  - **Layer 1 (Exact)**: SHA-256 content hash match → silent skip (no write)
  - **Layer 2 (Semantic)**: Vector cosine similarity > 0.90 → tag with `potential-duplicate` frontmatter
  - **Layer 3 (Keyword)**: FTS5 BM25 query → detect high keyword overlap
  - `remember` MCP tool now reports dedup results: `exact_duplicate`, `near_duplicate_tagged`, or `created`

- **`get_memory` MCP Tool**: Drill-down from recall snippets to full memory content
  - Input: `{ id, scope? }` — returns full markdown content with metadata
  - Complements snippet-only `recall` for context-efficient memory access

- **Snippet-Only Recall Format**: `recall` now returns ~300 char snippets instead of full content
  - Response includes `searchTier`, `snippet`, `chunkLocation` (file, startLine, endLine)
  - ~200 tokens for 5 results (was ~15k tokens with full content)
  - Use `get_memory(id)` to read full content when needed

- **Project Isolation Fix (Multi-Instance)**:
  - MCP server resolves project root at startup via git walk from `cwd()`
  - All memory operations accept explicit `projectRoot` parameter
  - Hooks read `cwd` from JSON input instead of `process.cwd()`
  - Session logs scoped by project hash: `active-session-{hash}.jsonl`
  - State files scoped by project hash: `context-memory-state-{hash}.json`

- **Selective Git Tracking for Memory**:
  - `notes/` directory is git-tracked (curated knowledge)
  - `sessions/`, `index.db`, `.db-journal` are gitignored
  - Replaces previous blanket `.claude/mem/` ignore

### Changed

- **`recall` Response Format**: Returns snippet-only results with search tier info (breaking change for consumers that expected full `content` field)
- **`remember` Response Format**: Now includes `reason` field (`created`, `exact_duplicate`, `near_duplicate_tagged`) and optional `nearDuplicate` info
- **`forget` Response Format**: Now includes `indexCleaned` field indicating whether SQLite entries were cleaned up
- **`memory_status` Response Format**: Now includes `indexStatus` with `initialized`, `dbPath`, `filesIndexed`, `chunksIndexed`, `ftsAvailable`, `embeddingProvider`, `searchTier`
- **Hook Consolidation**: `auto-memory.ts` deleted, functionality absorbed by `context-memory.ts` with dual triggers (PostToolUse + Stop)
- **Default recall limit**: Changed from 10 to 5 results for better context efficiency
- **Memory Config Schema**: Added `embedding`, `chunking`, `search`, and `dedup` configuration sections

### Fixed

- **WASM Loading on Windows/Bun**: `locateFile` returned file paths that Bun treated as URLs (`ConnectionRefused`). Fixed by pre-reading WASM file into `wasmBinary` buffer instead of relying on `locateFile` callback.
- **`memory_status` Not Initializing Indexer**: `memory_status` now calls `ensureIndexer()` so it always reports accurate index status (filesIndexed, chunksIndexed, searchTier).
- **`forget` Not Cleaning Index**: `forget` now calls `ensureIndexer()` to ensure index cleanup happens even if no prior `recall`/`remember` was called.
- **Graceful Embedding Degradation**: Hybrid search catches embedding API errors (e.g., 429 rate limit) and automatically falls back to FTS5-only within the same query.

### Removed

- **`auto-memory.ts` hook**: Consolidated into `context-memory.ts` to eliminate duplicate session capture

### Technical Details

- **Database**: Single SQLite database at `~/.claude/oh-my-claude/memory/index.db`, indexes both project and global scopes
- **Schema**: `files` (tracking), `chunks` (segments), `chunks_fts` (FTS5 virtual table with content= pattern + triggers), `embedding_cache` (vector cache), `meta` (version)
- **WASM**: `sql-wasm.wasm` loaded via `wasmBinary` buffer (not `locateFile`) for Bun/Windows compatibility. Resolved from node_modules, install dir, or alongside DB file.
- **Vector Search**: Cosine similarity computed in JavaScript (not sqlite-vec) — fast enough for typical memory stores (<1000 chunks)
