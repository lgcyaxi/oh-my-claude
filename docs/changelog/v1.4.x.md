# v1.4.x Changelog

## v1.4.2-beta.1 - 2026-02-05

### Fixed

- **npm Package Missing `dist/`**: Added `"files"` field to `package.json` to explicitly include `dist/`, `bin/`, `src/commands/`, and `src/styles/*.md` in the published npm package. Previously `.gitignore` excluded `dist/` and npm respected it, causing `npx install` to deploy a placeholder MCP server instead of the real one
- **Windows: `which` → `where`**: CLI `doctor` and `setup-tools` commands used Unix-only `which` to check for `ccline`; now uses `where` on Windows
- **Windows: Root directory traversal**: `context-memory.ts` hook used `dir !== "/"` loop guard which never terminates on Windows (roots are `C:\`, `D:\`, etc.); now uses `parent === dir` check that works on all platforms
- **Windows: Hook path separators**: `settings-merger.ts` split paths on `/` only, failing to match existing hooks on Windows backslash paths; now splits on both `/` and `\`
- **Windows: Hook command quoting**: Hook install commands used string concatenation with `/` (`${hooksDir}/file.js`) producing invalid paths on Windows; now uses `join()` with proper quoting

### Changed

- **CLAUDE.md**: Added git commit convention requiring changelog updates before each commit

---

## v1.4.2-beta.0 - 2026-02-05

### Added

- **Project-Scoped Memory**: Memories can now be stored per-project in `.claude/mem/` under the project root
  - Auto-detects git repo root for project boundary
  - Project memories ranked higher than global in search results
  - Default write scope: `project` (when in a git repo), `global` (otherwise)
  - Read scope defaults to `all` (both project + global)
- **Memory Compaction (`/omc-compact`)**: AI-assisted memory grouping and merging
  - Analyzes all memories using external AI (ZhiPu → MiniMax → DeepSeek fallback)
  - Suggests merge groups with titles and reasoning
  - Interactive confirmation: compact all, specific groups, or cancel
  - `compact_memories` MCP tool with `analyze` and `execute` modes
- **Context-Aware Auto-Save Hook**: `PostToolUse` hook auto-saves session memory at context threshold
  - Uses session log file size as proxy for context consumption (~100KB default)
  - Provider priority: ZhiPu → MiniMax → DeepSeek (configurable)
  - State tracking prevents duplicate saves (20KB buffer between saves)
  - Saves to project `.claude/mem/sessions/` when in git repo
- **Scope Parameter for All Memory MCP Tools**: `remember`, `recall`, `forget`, `list_memories` now accept `scope` parameter (`project`, `global`, `all`)
- **Memory Status Enhancements**: `memory_status` now returns scope breakdown (`byScope.project`, `byScope.global`), `projectPath`, and `defaultWriteScope`
- **Memory CLI Scope Support**:
  - `memory list --scope <project|global|all>` with `[P]`/`[G]` scope tags
  - `memory search --scope <project|global|all>` with scope tags
  - `memory delete --scope <project|global|all>`
  - `memory status` shows scope breakdown
  - `memory compact` subcommand with instructions
- **Memory Configuration Schema** (`MemoryConfigSchema`):
  - `defaultReadScope`: project / global / all (default: all)
  - `defaultWriteScope`: project / global / auto (default: auto)
  - `autoSaveThreshold`: 0-100% (default: 75, set 0 to disable)
  - `aiProviderPriority`: provider order array (default: zhipu, minimax, deepseek)

### Changed

- **Installer MCP Binary Detection**: Compares file sizes to detect MCP server binary changes, shows restart warning when binary is updated
- **Memory Store**: Complete rewrite for dual-scope storage with project-first ranking
- `.gitignore`: Added `.claude/mem/` to prevent committing project memory data

### Fixed

- **MCP Server Update Visibility**: Users now see "Restart Claude Code to load new features" when the MCP server binary changes during install (previously silent)

## v1.4.1 - 2026-02-05

### Changed

- Moved `README.md` to repository root for npm package visibility
- Updated `CLAUDE.md` with new README location reference

## v1.4.0 - 2026-02-05

### Added

- **Live Model Switching (Proxy)**: HTTP proxy server that intercepts Claude Code's native API calls for in-conversation model switching
  - Proxy server on port 18910 (configurable) — Claude Code connects via `ANTHROPIC_BASE_URL`
  - Control API on port 18911 (configurable) — health, status, switch, revert endpoints
  - Signal file IPC (`proxy-switch.json`) for zero-overhead coordination between MCP and proxy
  - SSE streaming passthrough using `ReadableStream` — no buffering
  - Auto-revert via request counter + timeout (default: 1 request, 10 min timeout)
  - Graceful fallback to native Claude when provider API key is missing
- **`/omc-switch` Slash Command**: Switch models directly in conversation
  - Shortcut aliases: `ds` (DeepSeek Chat), `ds-r` (DeepSeek Reasoner), `zp` (ZhiPu), `mm` (MiniMax)
  - Supports revert via "switch back" / "revert" in arguments
  - Usage: `/omc-switch ds-r 3` → next 3 requests via DeepSeek Reasoner
- **OAuth Proxy Support**: Proxy works with Claude Code OAuth sessions (no `ANTHROPIC_API_KEY` required)
  - Auto-detects auth mode: `api-key` (traditional) or `oauth` (passthrough)
  - OAuth mode forwards original auth headers (`authorization`, `x-api-key`) as-is to Anthropic
  - CLI `proxy enable` shows detected auth mode
- **Proxy MCP Tools** (3 tools):
  - `switch_model` — Switch next N requests to external provider (DeepSeek, ZhiPu, MiniMax)
  - `switch_status` — Query current proxy switch state
  - `switch_revert` — Immediately revert to native Claude passthrough
- **Proxy CLI Commands**:
  - `oh-my-claude proxy start` — Start proxy daemon
  - `oh-my-claude proxy stop` — Stop proxy daemon
  - `oh-my-claude proxy status` — Show proxy state
  - `oh-my-claude proxy enable` — Enable proxy in config
  - `oh-my-claude proxy disable` — Disable proxy in config
  - `oh-my-claude proxy switch <provider> <model>` — Manual model switch from CLI
- **Proxy StatusLine Segment**: Shows `[→DS/R ×2]` when switched (hidden otherwise)
  - Arrow prefix indicates redirected traffic
  - Provider/model abbreviation + remaining request count
  - Yellow color for attention during switch
  - Added to `standard` and `full` presets
- **`skipInitialRequests` for Proxy Switch**: First N requests after model switch are skipped from counting, compensating for slash command internal API overhead (default: 2)
- **Memory Awareness Hook**: `UserPromptSubmit` hook nudges Claude to use memory proactively
  - Fires on significant user messages when memories exist
  - Injects context: "N memories available. Consider using recall/remember."
  - Agents now recall before work and remember after decisions
- **Memory Integration in Commands**: `/omc-sisyphus` and `/ulw` now include Memory Integration sections
  - Recall relevant memories before planning
  - Remember key decisions and findings after work
- **Session Prompt Logging**: User prompts are now logged to `active-session.jsonl` for richer session context
- **Completion Trigger Detection**: Memory awareness hook detects task completion signals (`commit`, `done`, `finish`, `complete`, `session-end`) and assertively prompts `remember()` calls
- **Agent Capability Awareness**: All agents (Oracle, Analyst, Librarian, Frontend-UI-UX, Document-Writer, Sisyphus) now include capability sections documenting memory tools (`recall`/`remember`) and hot-switch model switching

### Changed

- **Oracle Agent**: Default provider changed from `deepseek` (deepseek-reasoner) to `claude` (claude-sonnet-4.5) for higher-quality reasoning
- Proxy auth supports dual mode: `api-key` and `oauth` (auto-detected)
- Installer now deploys proxy server to `~/.claude/oh-my-claude/`
- StatusLine config schema updated with `proxy` segment (position 9)
- CLI `statusline toggle` command accepts `proxy` segment
- Build system includes `build:proxy` target

### Fixed

- **Proxy CLI Windows Support**: Replaced Unix-only `curl` health checks with cross-platform Node `http` module, replaced `pgrep` process discovery with PID file + platform-specific fallback (`wmic` on Windows, `pgrep` on Unix)
- **Proxy Start on Windows**: Added `shell: true` and `windowsHide: true` spawn options for background daemon on Windows; env variable hint now shows `set` instead of `export`
- **Statusline Missing Segments**: Fixed `loadConfig()` not backfilling new segments (memory, proxy) for existing config files created before these segments were added — Zod filled missing keys with `enabled: false` instead of preset-aware defaults
- **Statusline Config Backfill**: `applyPresetToConfig()` now compares raw file keys against all known segments and applies preset-appropriate defaults for any missing ones, auto-persisting the updated config
