# v2.0.x Changelog

## v2.1.0-beta.3 - 2026-02-18

### Fixed

- **CC WezTerm Launch Hidden on Git Bash**: Fixed `oh-my-claude cc` from Git Bash not showing the WezTerm window. Root cause: `spawnSync` with inherited stdio was blocking GUI window creation. Fix: use `spawn` (detached, unref) for `wezterm start` path so the WezTerm process runs independently.

- **CC Already-in-WezTerm Opens New Tab**: When running `oh-my-claude cc` from inside an existing WezTerm window (detected via `$WEZTERM_PANE`), Claude Code now opens in a new tab instead of spawning a new window. Uses `wezterm cli spawn` (without `--new-window`) for tab-based launch.

- **Bridge Pane CWD**: Bridge `createPane` now passes `--cwd` (WezTerm) / `-c` (tmux) so codex/opencode launch in the correct project directory. Previously panes inherited the terminal's default cwd (usually `~`), causing OpenCode's storage adapter to miss session data and response polling to time out.

### Added

- **WezTerm Split-Pane Layout for Bridge**: `bridge up codex opencode` now uses `wezterm cli split-pane` to arrange bridge AIs in a split layout within the same WezTerm tab — matching the existing tmux behavior. First AI splits right from the CC pane (50%), subsequent AIs stack vertically below. Layout: `|CC|codex,opencode|`. Use `--detached` to open in separate windows instead.

- **WezTerm Config `--force` with Existing Marker**: Fixed `wezterm-config --force` not overwriting when oh-my-claude config was already present. The marker check now respects the `--force` flag.

- **WezTerm Config Lua Escape Sequence**: Fixed `invalid escape sequence near '[/\]'` Lua syntax error in the generated Git Bash detection pattern. Properly escape backslashes for Lua string literals.

- **WezTerm Config Zsh Auto-Detection**: The generated `.wezterm.lua` now auto-detects zsh in Git Bash installations (checks both `bin/` and `usr/bin/`). If found, launches via `bash -i -l -c zsh` (same as Windows Terminal). Priority: zsh > Git Bash > PowerShell. Git Bash location detection uses multiple candidate paths plus `where git` fallback.

---

## v2.1.0-beta.2 - 2026-02-18

### Added

- **WezTerm Config Command (`wezterm-config`)**: New `oh-my-claude wezterm-config` writes a preset `~/.wezterm.lua` optimized for AI coding sessions. Includes 50k scrollback, JetBrains Mono font, Dracula theme, WebGpu renderer, vi-style copy mode, quick select (URL/path/hash picker), regex scrollback search, pane splitting, and Alt+arrow navigation. Shell integration hints printed after install.

### Improved

- **Cross-Platform tmux Clipboard**: `oh-my-claude tmux-config` now auto-detects the correct clipboard command per platform: `pbcopy` (macOS), `clip.exe` (Windows/WSL), `xclip` (Linux), `xsel` (Linux fallback). WSL detection via `uname -r`. All copy-mode bindings (`y`, `Enter`, `MouseDragEnd1Pane`) use the detected command. Warns if no clipboard tool found on Linux.

- **tmux Mouse Drag → System Clipboard**: Added `MouseDragEnd1Pane` binding and `copy-command` global setting so mouse-selected text goes directly to the system clipboard (not just tmux internal buffer).

---

## v2.1.0-beta.1 - 2026-02-18

### Fixed

- **Kimi Proxy Sanitization**: Fixed 400 errors when switching to Kimi through the proxy. The `tool_reference` content type (Claude Code internal type) caused 400 errors. Kimi now gets minimal sanitization - only `tool_reference` is stripped. Thinking blocks and config work fine with Kimi and are preserved. ZhiPu and MiniMax remain zero-sanitization (fully Anthropic-compatible, handle all content types natively).

---

## v2.1.0-beta.0 - 2026-02-17

### Added

- **CC-to-CC Bridge (`bridge up cc`)**: Spawn Claude Code instances as bridge workers, each with its own proxy session for isolated model switching. Enables routing team tasks to cheap external models (DeepSeek, ZhiPu, MiniMax) instead of Opus tokens.
  ```bash
  oh-my-claude bridge up cc                    # Spawn CC with own proxy
  oh-my-claude bridge up cc --switch ds        # Auto-switch to DeepSeek
  oh-my-claude bridge up cc cc:2 cc:3          # Multiple independent instances
  oh-my-claude bridge send cc "research task"  # Delegate and poll response
  ```

- **CCDaemon (`src/daemon/ais/cc.ts`)**: New daemon implementation for CC bridge workers. Spawns `oh-my-claude cc -t none` in a tmux pane. Response capture via pane-output polling (monitors prompt return pattern). No storage adapter needed.

- **Multi-Instance CC Support (`cc:N`)**: Bridge names can now have suffixes (e.g., `cc:2`, `cc:worker1`). Each instance gets its own pane, proxy session, and model switch state. Base name is used for config lookup, full name for state tracking.

- **Bridge `--switch` Option**: `bridge up cc --switch <alias>` auto-sends `/omc-switch <alias>` to the CC pane after initialization. Supports all switch aliases (ds, zp, mm, km, etc.).

- **CC Pane Response Polling (`pollCCPaneResponse`)**: New polling function in `poll-response.ts` for CC bridge workers. Monitors tmux/wezterm pane output for processing→idle transition, extracts response text between injected message and returning prompt.

- **`bridge_send` CC Support**: MCP `bridge_send` tool now supports `cc` and `cc:N` targets. Uses pane-output polling for response capture instead of storage adapters.

- **Sisyphus CC Bridge Routing**: Sisyphus routing table updated with CC bridge entries for research/reasoning (pre-switched to ds/zp) and long-form docs (pre-switched to mm).

### Fixed

- **`bridge_send` paneId ReferenceError**: Fixed `paneId` used before declaration in MCP server `bridge_send` handler (used `entry.paneId!` instead).
- **Fast-response detection in CC polling**: `pollCCPaneResponse` now captures responses even when CC completes before the first processing indicator is detected. Uses baseline line count comparison.
- **Pane output chrome filtering**: Added `CC_CHROME_PATTERNS` to strip terminal decorations (statusline, emoji segments, separator lines) from extracted CC responses.
- **Sisyphus bridge awareness gap**: Added bridge delegation routing table and `bridge_send` usage to `SISYPHUS_PROMPT` in `sisyphus.ts`. Previously, only `/omc-sisyphus` command had bridge routing — Task-spawned Sisyphus instances were missing it.
- **CC pane response capture stability**: Replaced baseline-based detection with stable-content polling (2 consecutive identical extractions). Increased scrollback from 50→200 lines. Added `CC_IDLE_ANIMATION` filter for CC idle animations (`✻ Canoodling…`, `· Moonwalking…`).
- **OpenCode bridge_send timeout (3 root causes)**:
  1. Missing `paneMonitor` in CLI `bridge send` for opencode — only polled storage adapter (which never updates for bridge-injected messages). Added pane monitor creation for opencode/codex.
  2. No `OPENCODE_IDLE_PATTERN` — OpenCode uses `tab agents ctrl+p commands` as idle indicator, not `❯` prompt. Added pattern and integrated into `checkPaneState`.
  3. Fast-response detection gap — `checkPaneState` required `processing → idle` transition for early exit, but OpenCode's processing window (~200ms) is too brief for the 2.5s pane check interval. Added 2-consecutive-idle detection: from `unknown` → `idle` → `idle` triggers early exit.
- **OpenCode TUI chrome filtering**: Added `OPENCODE_CHROME_PATTERNS` to filter box-drawing chars, agent status lines, sidebar content. Added sidebar stripping (cut at 10+ consecutive spaces) and border prefix removal in `extractResponseFromPaneOutput`.
- **OpenCode processing detection**: Added `[⬝■]{3,}` progress bar pattern and `esc\s+(?:to\s+)?interrupt` to `PROCESSING_PATTERNS` for OpenCode's progress indicator.
- **Installer CLI dist copy**: Added step 4a2 in installer to copy `dist/cli.js`, `dist/index.js`, and `.wasm` files to `~/.claude/oh-my-claude/dist/`. Previously, `install-local` only copied hooks/MCP/statusline/proxy, leaving stale CLI code.

---

## v2.0.0-beta.14 - 2026-02-18

### Added

- **`wait_for_tasks` MCP Tool**: New blocking MCP tool that waits for multiple background tasks to complete. Supports `any` mode (return on first completion) and `all` mode (wait for all). Max timeout 300s. Eliminates repeated `poll_task` calls, saving tokens.

- **Task Completion Signal Files**: Background tasks now write signal files to `~/.claude/oh-my-claude/signals/completed/` on completion. PostToolUse and UserPromptSubmit hooks scan for these signals, enabling passive discovery of completed tasks without explicit polling.

- **Bridge Auto-Close (`auto_close`)**: `bridge_send` MCP tool now accepts `auto_close` parameter (default: `true`). After receiving a response, the AI pane is automatically killed and removed from bridge state. Set `auto_close: false` for persistent panes.

- **Per-Session Bridge Request State**: Bridge requests are now tracked per-session in `~/.claude/oh-my-claude/sessions/{session-id}/bridge-requests.json`. Per-session request counts available via `readSessionBridgeState()`.

- **Task Notification Hook (PostToolUse:*)**: Enhanced task-notification hook now triggers on ALL PostToolUse events (not just MCP tools), scanning signal files for completed task notifications.

- **Bridge Default Pane-Right Layout**: `bridge up` now defaults to `--pane-right` (opens AI alongside Claude Code in split view). Use `--detached` to open in a separate window instead. Old `--pane-right` flag removed.

### Changed

- **`poll_task` Max Wait**: Increased from 60s to 300s, matching `execute_agent` timeout. Reduces polling frequency for long-running tasks.

- **Codex Session Discovery**: `findLatestCodexSession()` now recursively walks `~/.codex/sessions/` to find session files in nested date directories (Codex v0.101+ stores as `YYYY/MM/DD/*.jsonl`). `CodexStorageAdapter` supports full file paths as session IDs.

- **Codex Prompt Detection**: Added `›` (U+203A) to `PROMPT_PATTERNS` and new `CODEX_IDLE_PATTERN` (`N% context left`) for reliable idle state detection. Added Codex-specific processing patterns (`Inspecting`, `Explored`, `esc to interrupt`).

### Fixed

- **Bridge Multi-Line Messages**: Fixed multi-line messages being split on `\n` and sent as separate prompts to codex/opencode. Now uses `tmux load-buffer` + `paste-buffer` to paste the entire message as a single block. Both MCP `bridge_send` and CLI `bridge send` fixed.

- **Bridge Up Exit Hang**: `bridge up` no longer hangs after printing success. Daemon idle timers were keeping the Node.js event loop alive. Now calls `process.exit(0)` after persisting state.

- **Bridge Send Verification Delay**: Reduced post-send verification from 1.5s + 2x 1s retries to 500ms + single 300ms retry. Total worst-case overhead reduced from 4.5s to 800ms.

### Removed

- **Custom Team Templates (`/omc-team`)**: Removed custom team feature (fullstack, research, visual, docs, review templates) in favor of Claude Code's native Agent Teams (`TeamCreate`, `TaskCreate`, `SendMessage`). Installer now cleans up old team files from `~/.claude/oh-my-claude/teams/`.

- **Bridge Statusline Segment**: Removed `bridge` segment from statusline (`src/statusline/segments/bridge.ts`). Bridge AIs are now visible by default (pane-right layout), making a statusline indicator redundant.

---

## v2.0.0-beta.13 - 2026-02-17

### Added

- **Native TeamCreate Integration (`/omc-team`)**: Rewrote `/omc-team` from an advisory copy-paste prompt generator to an action-oriented native team creation flow. Now instructs Claude to call `TeamCreate` -> `TaskCreate` -> `Task` (spawn) -> `TaskUpdate` (assign). Includes capability checks (proxy availability, provider configuration, bridge detection), route directive injection, and quick reference table for all team templates.

- **Bridge CLI Tool Delegation (Sisyphus)**: Added bridge-aware routing to Sisyphus orchestrator. New routing table maps task types (scaffolding, refactoring, code gen, boilerplate, visual-to-code) to bridge-active vs bridge-inactive fallbacks. Process steps updated to include bridge status check before delegation. Escalation routing table added for bridge-aware agent selection.

- **Machine-Parseable Team Templates**: Restructured all 5 team templates (`fullstack`, `research`, `visual`, `docs`, `review`) with standardized `## Roles` tables (Role, Name, Agent Type, Route Directive, Responsibilities), `## Fallback Rules` with bridge awareness, and `## Spawn Configuration` with per-role prompt suffixes. Replaced copy-paste spawn blocks with structured data that the `/omc-team` command can parse directly.

---

## v2.0.0-beta.12 - 2026-02-18

### Fixed

- **Codex Daemon: Real TTY Launch**: Codex now launches directly with a real TTY instead of piping stdin through a FIFO (`sh -lc 'while true; do cat FIFO; done | codex'`). The old approach replaced the TTY, causing "stdin is not a terminal" and preventing the Codex TUI from rendering. Now uses the same pattern as OpenCodeDaemon: pane first, optional IPC, terminal injection fallback.

- **Codex/OpenCode Send: IPC-first with Terminal Fallback**: `CodexDaemon.send()` now tries IPC channel first, and on failure gracefully falls back to `terminal.injectText()` (tmux `send-keys -l`). Previously it threw a hard error when IPC was unavailable.

- **tmux send-keys Bracketed Paste Fix**: Added 50ms delay between text injection (`send-keys -l`) and Enter keystroke in both `TmuxBackend.injectText()` and `bridge send` CLI. TUI apps (Codex, OpenCode) with bracketed paste enabled were treating the Enter as a newline in pasted text instead of a submit action.

- **Bridge `--pane-right` Stacking**: When launching AIs in separate `bridge up` calls with `--pane-right`, subsequent AIs now correctly stack below existing AI panes instead of creating new horizontal splits. Previously `firstRightPaneId` was local to each invocation, so every call treated the AI as the first right pane. Now reads existing AI pane IDs from bridge state.

- **Statusline Bridge Segment**: Fixed `[○ bridge]` always showing even when AIs are running. Root cause: the statusline (a bundled separate process) dynamically imported the bridge module and got a fresh `BridgeOrchestratorImpl` singleton with no registered AIs. Now reads directly from the runtime state file (`bridge-state.json`).

- **Kimi Login Detection**: Fixed premature login detection in `kimi-login.ts`. The URL-based check (`!url.includes("/login")`) immediately passed because Kimi's homepage never contains `/login`. Now polls `localStorage.getItem("access_token")` every 2s to detect actual authentication. Timeout extended to 5 minutes for QR code scanning.

---

## v2.0.0-beta.11 - 2026-02-17

### Added

- **`cc` Terminal Window Launch**: `oh-my-claude cc` now detects WezTerm or tmux and launches Claude Code in a **new terminal window**, returning the current terminal immediately. Falls back to inline launch when no multiplexer is found. New `--terminal` option (`auto|wezterm|tmux|none`) for explicit control.

- **`cc list` / `cc stop`**: Subcommands to manage detached CC sessions. `cc list` shows active sessions with PID, port, terminal backend, pane ID, and age. `cc stop [sessionId]` kills the proxy, terminal pane, and cleans up registry.

- **Inline tmux Wrapping**: On Git Bash (Windows) and Unix, `cc` auto-wraps Claude Code in a foreground tmux session even in inline mode. Enables scrollback, mouse, and proper terminal multiplexer features.

- **Detached Proxy Daemon** (`spawnDetachedProxy`): New spawn mode in `proxy-lifecycle.ts` that starts the proxy as an unref'd background process surviving parent exit. Used by `cc` terminal launch path. Log file at `~/.claude/oh-my-claude/proxy-{sessionId}.log`.

- **Terminal Detect Utility** (`src/cli/utils/terminal-detect.ts`): Lightweight binary probe for WezTerm/tmux without creating panes. Platform-aware priority: Git Bash → tmux first; Windows → WezTerm first; Unix → tmux first.

### Fixed

- **Git Bash tmux Priority**: Terminal factory now detects Git Bash/MSYS2 (via `MSYSTEM` env var) and prefers tmux over WezTerm. Previously WezTerm was always first on Windows, but tmux is native and lightweight in Git Bash.

- **Windows Terminal Backend Fixes**: `wt.exe` is a UWP App Execution Alias that requires `shell: true` to resolve. Added `shell` option to `BaseTerminalBackend.runCommand()`. Detection now uses `where.exe wt.exe` instead of `wt.exe --help` (which opens a new GUI window). Proper quote handling for tab titles and startup commands.

- **Bridge Statusline Segment**: Updated to read from persisted bridge state file instead of in-memory orchestrator. Shows running AI count and names from `bridge-state.json`.

- **`tmux-config` CLI Command**: `oh-my-claude tmux-config` writes recommended tmux configuration optimized for Claude Code sessions. Key settings: 50K scrollback, mouse mode (scroll = history), 256-color, zero escape delay, vi copy mode. Supports `--show`, `--force`, `--append` options. Auto-reloads active tmux sessions.

- **Bridge tmux Backend Support**: `bridge up/down/send/ping` now fully supports tmux alongside WezTerm. When running inside a tmux session, bridge creates AI panes as new tmux windows in the current session. Includes proper terminal backend detection via `$TMUX` and `$MSYSTEM` env vars.

### Fixed

- **Doctor: Kimi OAuth Check**: OAuth Credentials section now checks for Kimi alongside MiniMax. Previously only MiniMax was shown.

- **Doctor: Memory Count on MSYS/Git Bash**: Project root detection used manual `.git` walk-up which failed on MSYS paths. Now uses `git rev-parse --show-toplevel` as primary method with `.claude/mem` as fallback indicator.

- **tmux Format String Brace Stripping**: Replaced `#{pane_id}`, `#{session_name}`, etc. with short aliases (`#D`, `#S`, `#T`) throughout `TmuxBackend`. MSYS/Bun runtime strips `{}` braces from command arguments, causing tmux format expressions to fail.

### Changed

- **Proxy Registry Extended**: `ProxySessionEntry` now includes optional `paneId`, `terminalBackend`, and `detached` fields for terminal-launched sessions.

---

## v2.0.0-beta.10 - 2026-02-17

### Added

- **`bridge send` CLI Command**: Send messages to running AI assistants (Codex, OpenCode, Gemini) from any terminal. Messages are delivered to the AI's WezTerm pane and optionally polls for a response via storage adapters.
  ```bash
  oh-my-claude bridge send codex "What is 2+2?"
  oh-my-claude bridge send codex "Fix the login bug" --no-wait
  oh-my-claude bridge send opencode "Refactor auth module" --timeout 60000
  ```

- **`bridge_send` MCP Tool**: Claude can now delegate tasks to running CLI tools (Codex, OpenCode) via the MCP server. Reads bridge state, sends text via WezTerm CLI, and polls storage adapters for assistant responses. Enables true multi-AI collaboration within Claude Code sessions.

- **Bridge Response Polling** (`src/bridge/poll-response.ts`): New module that snapshots current messages from a storage adapter, then polls every 500ms for new assistant messages. Supports both Codex JSONL and OpenCode file-based storage.

- **Bridge State Extended**: `AIEntry` now persists `paneId`, `terminalBackend`, and `projectPath`. `bridge status` displays pane ID and backend columns. `bridge ping` uses WezTerm pane liveness checks.

- **Doctor: WezTerm & tmux Checks**: `oh-my-claude doctor` now checks for WezTerm and tmux installation with platform-specific install hints.

### Fixed

- **WezTerm Backend Rewrite**: Completely rewrote `src/terminal/wezterm.ts` to use proper WezTerm CLI APIs (`wezterm cli spawn`, `send-text`, `kill-pane`, `get-text`, `list`). Previously used `wezterm start` with detached processes and fake pane IDs — no text injection, no pane control, no output reading. Now captures real numeric pane IDs from `wezterm cli spawn` stdout.

- **TUI Submit Fix (text + CR two-step)**: TUI apps (Codex, OpenCode) treat `\n`/`\r\n` in pasted text as multi-line input, not submit. Fixed by sending text content first, then a separate raw `\x0d` (CR byte) to trigger the Enter/Submit action. Discovered via end-to-end testing.

- **`bridge down` Uses WezTerm `kill-pane`**: When a pane ID is available in bridge state, `bridge down` now calls `wezterm cli kill-pane` directly instead of relying solely on PowerShell process matching. More reliable and faster cleanup.

- **Shell Escaping in `send-text`**: Switched from `execSync` (shell string) to `spawnSync` with args array / stdin pipe for all WezTerm CLI calls. Prevents shell injection and special character corruption in messages.

### Changed

- **Daemon Base Class**: Added `getPaneId()` and `getProjectPath()` methods to `AIDaemon` base class, overridden in `CodexDaemon` and `OpenCodeDaemon`. Allows `bridge up` to extract and persist the real pane ID after daemon start.

- **`runCommand` stdin support**: `BaseTerminalBackend.runCommand()` now accepts an `input` option for piping data through stdin, used by WezTerm's `send-text` for reliable text delivery.

---

## v2.0.0-beta.9 - 2026-02-17

### Fixed

- **Bridge `down` Now Actually Kills Processes**: `bridge down` was silently removing state without killing the actual terminal process. Root cause: `unregisterAI()` returns early (no throw) when daemon isn't found in a fresh orchestrator, so the kill fallback never triggered. Now always uses PowerShell `Get-CimInstance` (via EncodedCommand) to find and kill `cmd.exe` processes matching the AI CLI name. On Unix uses `pkill`.

- **Bridge State Persistence Across CLI Invocations**: Each `bridge` CLI command is a separate process, so in-memory orchestrator state was lost. Added `src/bridge/state.ts` with JSON state file at `tmpdir/oh-my-claude-bridge/bridge-state.json`. `bridge up/status/down` now read/write persisted state.

- **Bridge Orchestrator Bugs** (from Codex code review):
  - `delegate()` race condition: requests now always start as "queued" instead of checking queue length
  - `loadBridgeConfigFromFile` now validates with `MultiBridgeConfigSchema.parse()` instead of raw cast
  - Bridge orchestrator changed from eager singleton to lazy getter with `resetBridgeOrchestrator()`
  - `calculateProjectId` in OpenCode daemon uses `git rev-parse --show-toplevel` (stable) instead of HEAD (changes every commit)
  - Removed dead `includesProjectFlag()` method from Codex daemon

### Changed

- **CLI Tools Prefer Bun Over npm**: `check-updates` and `install-cli` now detect if `bun` is installed and prefer `bun install -g` for package installs. Registry lookups still use `npm view` (bun has no equivalent). Detection is cached per-process.

---

## v2.0.0-beta.8 - 2026-02-17

### Added

- **Kimi Quota in Usage Statusline**: Kimi now shows actual usage % from the billing API (`GetUsages` with `FEATURE_CODING` scope) instead of `0req`. Requires Kimi credentials (`oh-my-claude auth login kimi`). Falls back to request count if no credentials.

- **ZhiPu Weekly Quota**: ZhiPu usage segment now shows short-window token %, remaining calls, AND weekly token usage % (format: `ZP:0%/3959c/w:2%`). Weekly quota uses `unit: 6` from the quota API.

- **Kimi Login: localStorage Token Extraction**: Kimi login script now extracts `access_token` from browser `localStorage` instead of intercepting Authorization headers from network requests. More reliable — navigates to console page post-login to ensure token is available.

### Fixed

- **MiniMax Usage % Was Inverted**: `current_interval_usage_count` is actually the remaining count, not used. Now correctly calculates `(total - remaining) / total` for usage percentage.

- **Kimi Window vs Weekly Quota**: Kimi was showing weekly quota as the primary display. Now shows window usage % (short-term rate limit) followed by weekly % (format: `KM:4%/w:10%`), matching ZhiPu's dual-display pattern.

- **`check-updates` Wrong Package Names**: All three CLI tool npm packages were wrong, causing version checks to silently fail. Fixed: `@openai/codex-cli` → `@openai/codex`, `@codeium/opencode` → `opencode-ai`, `@nicepkg/opencode` → `oh-my-opencode`. Also fixed in `doctor`, `install-cli`, and agent prompts.

### Changed

- **Statusline Line 2 Segment Order**: Reordered Line 2 segments: proxy (position 7) → memory (8) → preferences (9) → mcp (10) → usage (11). Proxy session ID now appears first on Line 2 for quick session identification.

- **Preferences Segment Moved to Line 2**: Preferences segment now renders on Line 2 (with `newLine: "true"`) alongside other monitoring segments.

---

## v2.0.0-beta.7 - 2026-02-16

### Fixed

- **Menubar Windows Build**: Fixed Rust compilation error in `apps/menubar/src-tauri/src/registry.rs`. `windows_sys::OpenProcess` returns `HANDLE` (= `isize`), not a pointer — `.is_null()` method doesn't exist. Changed to `handle == 0`. Also removed unused `ERROR_INVALID_PARAMETER` import.

- **MiniMax Login on Windows**: Fixed multiple issues preventing Playwright-based MiniMax login from working on Windows:
  - Playwright + Bun subprocess spawning doesn't work on Windows — browser launch hangs silently. Now runs the login script via Node.js (`npx tsx`) instead of Bun.
  - Playwright `channel` detection hangs under Bun — now uses explicit `executablePath` for Chrome/Edge detection via registry + known paths.
  - Added Edge (`msedge`) fallback for Windows where Chrome may not be installed.
  - Playwright is now installed on-demand (first MiniMax login) with `--ignore-scripts` to avoid triggering project build.
  - Fixed ESM `require is not defined` error — replaced with proper ES module imports.

- **Auth CLI Always Shows Usage Help**: `oh-my-claude auth` now always displays both the authenticated providers list AND the usage help, instead of only showing one or the other. Users see a complete view regardless of credential state.

### Changed

- **Playwright Moved to On-Demand**: Removed `playwright` from `package.json` dependencies. It's only installed when user first runs `oh-my-claude auth login minimax`. This avoids shipping the ~200MB browser binaries to all users.

- **Statusline Two-Line Layout Reorganized**: Segments are now split into two lines via `metadata.newLine` flag. Line 1: model | git | directory | context | session | output-style. Line 2: memory | mcp | proxy | usage (DS/ZP/MM quotas). The `renderSegments` function now joins all `newLine` segments into a single second line instead of creating separate lines per segment.

---

## v2.0.0-beta.6 - 2026-02-15

### Removed

- **Google/Antigravity Provider**: Completely removed Google Antigravity OAuth provider from all components due to persistent reliability issues. Removed from: proxy handler (routing, retry, stream conversion), proxy auth, config schema defaults, CLI proxy model listing, switch shortcuts, statusline segments (model, proxy, usage), menubar provider list, MCP tool descriptions, auth CLI (login/logout/add-account/switch-account for Google), agent defaults, config loader fallback chain, provider router.

### Changed

- **Frontend-UI-UX Agent**: Default provider changed from Google to Kimi (`kimi/K2.5`). Agent description updated to reflect Kimi K2.5 capabilities.

- **Visual-Engineering Category**: Default provider changed from Google to Kimi (`kimi/K2.5`).

- **Sisyphus/Ultrawork Routing**: UI/UX agent routing changed from `google/antigravity-gemini-3-pro` to `kimi/K2.5`.

### Fixed

- **Codex Stream `pipeThrough` Bug**: Replaced `pipeThrough` with manual reader/writer piping in `createResponsesToAnthropicResponse()`. Bun 1.x silently fails to invoke `TransformStream.transform()` when using `pipeThrough` with fetch response bodies. The same fix was already applied to the Antigravity converter but was missed for the Codex Responses API converter.

---

## v2.0.0-beta.5 - 2026-02-16

### Improved

- **Statusline Debug Branding**: `oh-my-claude cc --debug` now exports `OMC_DEBUG=1`, and statusline branding switches from `omc` to `omc[debug]` in both normal and ready states. This makes it obvious that debug mode is active for the current session.

- **OpenAI Model Defaults Unified to Codex**: `/omc-switch` shortcuts now route OpenAI/Copilot defaults to `gpt-5.3-codex` (`gpt`, `openai`, `codex`, `cx`, `copilot`, `cp`) to avoid tool-operation failures seen with `gpt-5.2` and `o3-mini` in Claude Code workflows.

- **Menubar OpenAI Model List Simplified**: Menubar provider model list now only shows `GPT-5.3 Codex` for OpenAI, removing `gpt-5.2` and `o3-mini` to match the supported tool-capable path.

- **Proxy CLI OpenAI Model List Simplified**: `oh-my-claude proxy switch` model listing now only exposes `gpt-5.3-codex` for OpenAI, removing unsupported defaults.

- **Menubar: Hide from Dock**: Menubar app now uses `ActivationPolicy::Accessory` to hide from Dock and Cmd+Tab switcher. Requires `macOSPrivateApi: true` in Tauri config.

- **Menubar: Simplified Session Labels**: Session rows now show `session_id - model` instead of `project_name [session_id] - model` for a cleaner tray menu.

- **Menubar: Remove Unused Props**: Cleaned up `ModelPicker` component by removing unused `controlPort` and `sessionId` props.

- **Installer: Fix Stale Menubar Source**: The installer now cleans menubar source files before copying fresh ones, preserving `node_modules` and `target` to avoid re-download/rebuild. Fixes issue where `oh-my-claude install` would keep stale source files.

- **Mandatory Memory Integration for All Agents**: Added `Memory Integration (MANDATORY)` blocks to 7 agent commands (sisyphus, oracle, hephaestus, reviewer, plan, start-work, ulw). Agents now MUST call `recall` before starting work and `remember` after completing work. Hook hint upgraded from passive suggestion to assertive `MUST` instruction.

- **CLAUDE.md Build & Test Workflow**: Added mandatory build/test workflow requiring `bun run build:all` + `bun run install-local -- --force` before verification. All testing must go through the installed `oh-my-claude` binary, not source directly.

---

## v2.0.0-beta.4 - 2026-02-16

### Fixed

- **Proxy Sessions Now Shows Correct Switched Model**: `oh-my-claude proxy sessions` and `oh-my-claude proxy status` now correctly display the session's switched model (e.g., `→ zhipu/GLM-5`) instead of always showing "native Claude". The control API `/status` endpoint requires `?session=ID` parameter to return session-scoped state, which the CLI was not passing.

- **Statusline Model Segment Now Shows Switched Model**: The model segment now correctly reads session-scoped switch state from the control API (via `/status?session={id}`) instead of the global state file. When switched to an external provider, displays `→MiniMax-M2.5` instead of the native Claude model.

- **Dynamic Control Port Support**: Statusline segments (model, proxy, usage) now read the control port from `OMC_PROXY_CONTROL_PORT` environment variable instead of hardcoded default. Fixes statusline showing wrong model when using per-session proxy with dynamic ports.

- **Simplified Proxy Segment Display**: Proxy segment now only shows session ID (`s:8ddc7c1f`) without duplicating provider/model info. The model segment already displays the actual model being used.

### Added

- **Debug Mode for Per-Session Proxy**: Added `-d, --debug` flag to `oh-my-claude cc`. When enabled, proxy stderr is written to `~/.claude/oh-my-claude/proxy-{sessionId}.log` for troubleshooting. Logs are session-scoped and auto-cleaned when session exits.

- **MiniMax Quota Display in Statusline**: MiniMax usage can now be displayed in the statusline. When `MINIMAX_API_KEY` is set AND user has logged in via `oh-my-claude auth login minimax`, the statusline shows quota percentage (e.g., `MM:78%`). Without auth, shows local request count (`MM:5req`).

- **MiniMax OAuth Login**: Added `oh-my-claude auth login minimax` command. Uses Playwright to open browser for QR code login. After login, extracts cookie and groupId from the coding-plan API. Credentials saved to `~/.claude/oh-my-claude/minimax-creds.json`. Required for MiniMax quota API access.

- **Menubar App CLI**: Added `oh-my-claude menubar` command to launch the menu bar app for session management. Supports `--dev` for development mode and `--build` to create release build. Auto-installs dependencies if missing. Uses `open` command on macOS to launch .app bundles.

- **Menubar App in npm Package**: The menubar app source is now included in the npm package and copied during `oh-my-claude install`. Users can run `oh-my-claude menubar --build` to build a native app, or `oh-my-claude menubar --dev` for development mode.

### Changed

- **Simplified Proxy CLI**: Removed `proxy start`, `proxy stop`, `proxy enable`, `proxy disable` commands. Proxy is now auto-managed per-session by `oh-my-claude cc`. New commands: `proxy status` (shows active sessions), `proxy sessions` (detailed list), `proxy switch`, `proxy revert`.

### Removed

- **Request Counting Mechanism**: Removed `requestsRemaining` and `skipInitialRequests` from `ProxySwitchState`. Switches are now permanent until manual `/omc-switch revert`. Simplifies the model switching UX.

- **OpenRouter Provider**: Removed OpenRouter provider from all components including config schema, provider routing, statusline display, doctor checks, and memory embeddings. The provider is no longer needed.

---

## v2.0.0-beta.3 - 2026-02-13

### Added

- **Proxy-Aware Agent Delegation**: Agent slash commands (`/omc-hephaestus`, `/omc-oracle`, `/omc-librarian`, `/omc-navigator`) now auto-detect the proxy and prefer `switch_model` + Task tool over MCP `launch_background_task`. This gives external models full access to Claude Code's tools (Edit, Write, Bash, Glob, Grep) instead of text-only responses. MCP remains as fallback when proxy is unavailable.

- **Sisyphus Proxy-Aware Routing**: Sisyphus orchestrator now checks proxy availability before delegating. When proxy is available, uses silent model switching + Task tool for all 7 agent types (hephaestus/oracle/analyst/librarian/document-writer/frontend-ui-ux/navigator). Falls back to MCP background tasks when proxy is unavailable.

- **Silent Model Switching**: All proxy-aware delegations switch models without user confirmation or announcement. The user explicitly invoked the agent command, which implies consent. Model routing is an internal implementation detail. Uses `requests=-1` (unlimited) for multi-turn Task tool agents, with automatic `switch_revert` after completion.

- **Strict Execution Guarantee**: All 7 proxy-aware commands (`omc-hephaestus`, `omc-oracle`, `omc-librarian`, `omc-navigator`, `omc-sisyphus`, `omcx-commit`, `omcx-docs`) now enforce a strict switch→Task→revert execution order. `switch_model` MUST be called before any non-tool response, `switch_revert` MUST be called after Task completes (even on error). Prevents stuck proxy state from interrupted flows.

- **Oracle Model Change**: Oracle agent switched from `deepseek/deepseek-reasoner` to `openai/gpt-5.3-codex`. DeepSeek Reasoner requires `thinking` blocks in assistant messages (incompatible with Task tool). GPT-5.2 also failed because the OpenAI OAuth endpoint only supports the Responses API (`/codex/responses`) — GPT-5.2 requests returned empty responses. GPT-5.3-codex works correctly and handles reasoning tasks well.

- **Action-First Prompt Structure**: Agent slash commands restructured with "IMMEDIATE ACTION REQUIRED" pattern — the model's FIRST tool call must be `switch_status`, with NO text output before it. Previous advisory-style instructions were too easily skipped by the model. The new structure forces action before explanation.

- **Ultrawork Proxy-Aware Agents**: `/omc-ulw` updated from MCP-only "Async Agents" to proxy-aware dual-mode agent table. Now lists all 7 agents with provider/model mappings and execution guarantee for switch+Task+revert flow.

- **Task Tool Parameter Guard**: All agent commands now explicitly specify `ONLY these parameters (do NOT add resume, team_name, or any other params)` in Task tool instructions. Prevents the model from hallucinating stale agent IDs or team contexts from conversation history, which caused retry loops and stuck sessions.

---

## v2.0.0-beta.2 - 2026-02-13

### Fixed

- **Duplicate Export Build Error**: `bun build --splitting` produced a shared `token-manager` chunk with duplicate `getAccessToken` exports, causing `SyntaxError: Duplicate export` on Node.js v25.6.1. Removed `--splitting` flag — each entry point now gets a self-contained bundle.

- **Statusline Missing Kimi Provider**: Added `kimi: "KM"` to provider abbreviation maps in proxy and MCP segments. Added `K2.5: "K2"` to model abbreviation maps. Previously Kimi was only recognized in the usage segment.

- **Statusline Missing MiniMax/Kimi in Standard Preset**: The `usage` segment (which shows configured provider stats) was only enabled in the "full" preset. Added it to the "standard" preset so configured providers are visible by default.

---

## v2.0.0-beta.1 - 2026-02-13

### Added

- **Navigator Slash Command (`/omc-navigator`)**: Kimi K2.5 now has a dedicated slash command for multimodal task execution — visual-to-code conversion, document processing, and multi-step workflow orchestration. Follows the same launch/poll pattern as `/omc-hephaestus`.

- **Navigator in MCP Tool Descriptions**: Navigator agent now listed in `launch_background_task` and `execute_agent` tool descriptions alongside the other 6 agents. Also added `visual-execution` category.

- **Conversation Context Passing**: New `conversation_context` parameter on `launch_background_task` and `execute_agent` MCP tools. Allows orchestrators (Sisyphus) to pass relevant conversation context to background agents, improving task understanding without full context replay.

- **Sisyphus Worker Delegation Guidelines**: Sisyphus now has explicit instructions to PREFER delegation to MCP workers over doing work itself. Guidelines map task types to specific agents (documentation → document-writer, research → librarian, visual → frontend-ui-ux/navigator, etc.) with detailed prompt requirements.

- **Sisyphus Smart Model Switching**: Sisyphus can now transparently switch Claude Code to external models for task types they handle better (Codex for code gen, DeepSeek Reasoner for reasoning, Gemini Pro for visual, MiniMax for long-form docs) using `/omc-switch` with `requests=-1` and `switch_revert`.

### Changed

- **Frontend-UI-UX Default Model**: Upgraded from `gemini-3-flash` to `gemini-3-pro` for better UI/UX quality. Flash remains as fallback.

- **Visual-Engineering Category**: Default model changed from `gemini-3-flash` to `gemini-3-pro`.

- **Sisyphus Routing Table**: Added Navigator entry for visual-to-code/multimodal/document processing tasks.

### New Files

- `src/commands/omc-navigator.md` — Navigator slash command (Kimi K2.5 multimodal)

---

## v2.0.0-beta.0 - 2026-02-13

### Breaking Changes

- **Major version bump** from 1.5.x to 2.0.0 — reflects the addition of OAuth authentication, OpenAI-format providers, and bidirectional format conversion in the proxy.

### Added

- **OAuth Authentication System**: Full OAuth PKCE flow support for Google Gemini, OpenAI Codex, and GitHub Copilot. Authenticate once, then use these providers' models through the proxy without API keys.
  - `oh-my-claude auth login <provider>` — Browser-based OAuth login
  - `oh-my-claude auth logout <provider>` — Remove credentials
  - `oh-my-claude auth list` — Show authenticated providers
  - `oh-my-claude auth add-account <provider>` — Add Google multi-account for quota rotation

- **Google Antigravity (OAuth Multi-Account)**: Google OAuth with PKCE + multi-account support. When one account's Gemini quota is exhausted, automatically rotates to the next account. Account pool tracks per-account exhaustion with 5-minute cooldown. Models: gemini-3-pro, gemini-3-flash, gemini-2.5-pro.

- **OpenAI Codex OAuth**: Browser-based OAuth PKCE flow + headless device code flow (`--headless`). Models: gpt-5.2, gpt-5.3-codex, o3-mini. Headless mode for SSH/remote environments.

- **GitHub Copilot OAuth**: Device code flow authentication. Works with github.com and GitHub Enterprise. Models via Copilot API: gpt-5.2, claude-sonnet-4.5, gemini-3-flash.

- **Proxy Format Converters**: Three distinct format converters for OAuth providers:
  - **Antigravity Converter** (`antigravity-converter.ts`): Anthropic ↔ Google Antigravity (Gemini native) format. Uses Cloud Code endpoints (`cloudcode-pa.googleapis.com`) with Antigravity envelope wrapping. Matches Antigravity Manager v1.15.8 Chrome/Electron User-Agent fingerprint. Handles text, functionCall, images, and thinking block stripping.
  - **Responses API Converter** (`responses-converter.ts`): Anthropic ↔ OpenAI Responses API format for Codex. Converts to `input` array + `instructions` format with `store: false`. Handles `response.output_text.delta`, `response.output_item.added`, and `response.completed` SSE events.
  - **OpenAI Chat Completions Converter** (`format-converter.ts`): Anthropic ↔ OpenAI Chat Completions for Copilot and OpenRouter. Standard `messages` array format with tool_calls support.

- **Universal Agent Fallback Chain**: When primary provider is not configured and explicit fallback also unavailable, agents now try any configured provider (deepseek → zhipu → minimax → kimi → google → openai → openrouter). Categories also get the same fallback. No more hard failures when a single API key is missing.

- **Hephaestus Agent**: New MCP background agent — code forge specialist for multi-file features, deep refactoring, code synthesis, migration work, and test generation. Default provider: OpenAI/gpt-5.3-codex. Slash command: `/omc-hephaestus`.

- **New Switch Shortcuts**: `/omc-switch` now supports OAuth providers:
  - `gm` / `gemini` → Google Gemini 3 Flash
  - `gm-p` / `gemini-pro` → Google Gemini 3 Pro
  - `gpt` / `openai` → OpenAI GPT-5.2
  - `cx` / `codex` → OpenAI GPT-5.3 Codex
  - `cp` / `copilot` → GitHub Copilot

- **Antigravity-Style Quota Display**: Google statusline uses `getAccountPoolStatus()` from account pool to show available/total accounts with exhaustion tracking. Single account: `GM:1acct` (green) or `GM:0/1` (red). Multi-account: `GM:2/3` (2 available of 3) with color degrading as accounts exhaust. Inspired by [AntigravityQuotaWatcher](https://github.com/wusimpl/AntigravityQuotaWatcher).

- **Usage Statusline Hides Unconfigured Providers**: Providers without API keys or OAuth credentials are completely hidden from the usage statusline. Proxy-only providers (MM, KM, AI, CP) only appear when they have active request counts. No more "0req" for inactive providers.

- **Auth CLI Command**: `oh-my-claude auth` with subcommands: login, logout, list, add-account, switch-account. Supports provider aliases (google/gemini, openai/codex/chatgpt, copilot/github/gh).

- **Google Account Switching**: `oh-my-claude auth switch-account google [N]` lists Google accounts and switches the active one. Without index, shows account list with active marker. Clears token cache on switch for immediate effect.

- **Doctor OAuth Check**: `oh-my-claude doctor` now shows OAuth credential status alongside API key providers. Split recommendations into API key vs OAuth setup suggestions.

- **Doctor Complete Command List**: `--detail` now lists all 16 omc-* commands (including `omc-switch`, `omc-team`, `omc-ulw`, `omc-hephaestus`) and 3 memory commands (`omc-mem-compact`, `omc-mem-clear`, `omc-mem-summary`) in categorized sections.

### Fixed

- **Embedding Connectivity Check**: Doctor's embedding provider connectivity test now uses `fetch()` instead of `curl`, fixing false "FAILED" results on Windows where `curl` single-quote JSON body syntax doesn't work. Both `--detail` and `--fix-mem` modes are fixed.

- **Auth "Bun is not defined"**: OAuth callback server in `src/auth/server.ts` replaced `Bun.serve()` with Node.js `http.createServer()`. The CLI runs via Node.js (`bin/oh-my-claude.js`), so Bun-specific APIs are not available. Also replaced `Bun.sleep()` with `setTimeout` in `codex.ts` and `copilot.ts`.

- **Local Provider Usage Display**: Configured local-only providers (MiniMax, Kimi, OpenAI, Copilot) now show `0req` when proxy is running but no requests made yet. Previously they were hidden entirely, making it look like config was lost. Providers are still hidden when proxy is not running.

- **Google Antigravity OAuth Credentials**: Fixed `restricted_client` / `Unregistered scope(s)` error by replacing incorrect Cloud Shell Editor client ID (`77185425430`) with the correct Antigravity client ID (`1071006060591`). Updated client secret, scopes (now includes `cclog`, `experimentsandconfigs`, `userinfo.profile`), callback port (51121), callback path (`/oauth-callback`), and added all three endpoint fallbacks (prod/daily/autopush) plus default project ID fallback for workspace accounts.

- **Google Antigravity Endpoint & Headers**: `generativelanguage.googleapis.com` does not accept Antigravity OAuth tokens — switched to Cloud Code endpoints (`daily-cloudcode-pa.sandbox.googleapis.com`). Updated User-Agent from `antigravity/1.11.5` to Chrome/Electron fingerprint matching v1.15.8, `ideType` from `IDE_UNSPECIFIED` to `ANTIGRAVITY`.

- **Antigravity Response Unwrapping**: Antigravity API wraps Gemini responses in `{"response": {"candidates": [...]}}` — converter now correctly unwraps the `response` key before processing candidates.

- **OpenAI Codex Responses API Compatibility**: Fixed multiple Codex API requirements: `instructions` field is required (added default fallback), `store` must be `false`, `max_output_tokens` is unsupported (removed), `temperature` and `top_p` are unsupported (removed). Also fixed stream detection — Codex doesn't set `Content-Type: text/event-stream` despite returning SSE data.

- **Full-Compat Providers Preserve Thinking Blocks**: ZhiPu, MiniMax, and Kimi all natively support `type="thinking"` content blocks per their Anthropic-compatible APIs. Sanitizer no longer strips thinking blocks for these providers, preserving the model's reasoning chain. Non-compat providers (DeepSeek, OpenRouter) still get full sanitization.

- **Google Antigravity 429 Account Rotation**: When a Google Antigravity request returns 429 (quota exhausted), the proxy automatically marks the current account as exhausted, rotates to the next available account via `rotateToNext()`, gets a fresh OAuth token, and retries (up to 3 attempts). Falls through to passthrough only when all accounts are exhausted. Works in both directive and switched routing paths.

- **Proxy Stop on Windows**: `oh-my-claude proxy stop` now tries the control API `/stop` endpoint first (most reliable, cross-platform), then PID file, then platform-specific process discovery. The wmic fallback pattern was fixed from forward-slash (`proxy/server.js`) to backslash-aware matching. `proxy disable` also fixed to use control API instead of Unix-only `pgrep`.

- **Google Statusline Shows Request Count**: `GM:` segment now shows proxy request count (like MM/KM) instead of just account count. Single account: `GM:3req`, multi-account: `GM:5req(2/3)`, all exhausted: `GM:0/1!`. No standalone Google API exists for Gemini quota percentage (AntigravityQuotaWatcher uses a local VS Code extension API).

- **Proxy Switch Never Reverts (Session/Global State Mismatch)**: When `handleMessages` fell back from session state to global state (session had no switch, but global did), `handleSwitched` still called `decrementAndCheckSession(sessionId)` which was a no-op (session already empty). The global state was never decremented, causing an infinite loop where every request routed to the switched provider forever. Fixed by passing `useSessionState` flag through to `handleSwitched` so it decrements the correct state (session vs global).

- **`skipInitialRequests` Lost Through Control API**: The MCP `switch_model` tool set `skipInitialRequests: 2` to skip slash command overhead, but didn't include it in the request to the control API. The control API also didn't accept or write it. This caused the first 2 overhead requests (tool result + confirmation) to consume the switch quota, making `requests=1` (default) exhaust before the user's actual message. Fixed both the MCP tool and control API to pass through `skipInitialRequests`.

- **OpenAI Responses API Tool ID Format**: Anthropic tool_use IDs (`toolu_xxx`) were passed directly to the OpenAI Responses API, which requires `fc_`-prefixed IDs. This caused 400 errors: `Invalid 'input[1].id': Expected an ID that begins with 'fc'`. The responses converter now maps Anthropic tool IDs to `fc_`-prefixed IDs, maintaining referential integrity between `function_call` and `function_call_output` items.

- **CLI `proxy switch` Session-Aware**: `proxy switch` now detects the session ID from `ANTHROPIC_BASE_URL` and targets the session-scoped state via control API `?session=ID`. Previously it only wrote global state, so switching from CLI always affected all sessions. Added `--session <id>` flag for explicit targeting.

- **CLI `proxy` Usage Missing Commands**: The custom `proxy` usage block now lists `switch`, `revert`, and `sessions` subcommands alongside start/stop/status/enable/disable.

### Added (post-beta.0)

- **MCP Proxy Routing with 4-Step Fallback**: MCP background agents now route tasks through the oh-my-claude proxy instead of making direct HTTP calls. This enables OAuth providers (OpenAI Codex, Google Gemini) that previously failed with 403/401 when called directly. Fallback chain: (1) Proxy with `[omc-route:provider/model]` directive → (2) Direct API call for API-key providers → (3) Claude subscription passthrough via proxy → (4) `[omc-fallback]` signal for Claude Code's built-in Task tool. All 6 MCP agents (analyst/DeepSeek, librarian/ZhiPu, document-writer/MiniMax, oracle/OpenAI, frontend-ui-ux/Gemini, hephaestus/Codex) verified working through proxy.

- **Proxy Non-Streaming JSON Response Support**: Proxy directive routes now support `stream: false` requests from MCP agents. Added `collectStreamToAnthropicJson()` that buffers SSE events into a single Anthropic Messages API JSON response. Includes format-specific JSON converters for OpenAI Chat Completions, Gemini Antigravity, and Responses API (Codex) responses.

- **`proxy revert` CLI Subcommand**: Revert to native Claude from CLI. Session-aware (auto-detects from env or `--session` flag). Previously only available via control API POST /revert.

- **`proxy sessions` CLI Subcommand**: List all active proxy sessions with their IDs, current switch state, per-session provider usage counts (e.g., `DS:3 ZP:1 CL:12`), and last activity. Makes it easy to identify which Claude Code instance is which and target it with `--session`.

- **`proxy switch` Provider/Model Listing**: Running `proxy switch` with no arguments now displays all available providers and their models instead of erroring with "missing required argument".

- **Per-Session Provider Tracking**: The proxy handler now records per-provider request counts per session (including passthrough as "anthropic"). Exposed via `GET /sessions` control API endpoint and `proxy sessions` CLI.

- **Statusline Session ID Display**: The proxy statusline segment now always shows the session ID when connected through the proxy: `[s:84d730f8]` in passthrough mode (neutral color), `[s:84d730f8 →DS/R ×2]` when switched (yellow). Previously the segment was hidden entirely in passthrough mode.

- **Antigravity Non-Streaming Returns Empty**: Google Antigravity's `generateContent` (non-streaming) endpoint returns empty responses for some models. Proxy now always uses `streamGenerateContent` for Antigravity directive routes (like Codex pattern), buffering SSE into JSON via `collectStreamToAnthropicJson()` when the caller requests `stream: false`.

- **Installer Nested Session Error**: Running `oh-my-claude install` inside a Claude Code session failed because `claude mcp add` detected the `CLAUDECODE` env var and refused with "cannot be launched inside another Claude Code session". Fixed by clearing `CLAUDECODE` from the environment before `execSync` calls to `claude mcp add/list/remove`.

- **Antigravity SSE Line Ending Mismatch**: SSE event boundary detection normalized `\r\n` → `\n` for robustness.

- **Antigravity Error Responses Swallowed Silently**: Google Antigravity API returns error responses (400, 503) with `Content-Type: text/event-stream` but the body is plain JSON, not SSE events. The handler checked content-type BEFORE status code, so errors were piped through the SSE converter which found 0 events and produced an empty stream — Claude Code showed "end without reply" with no error. Fixed by checking status code first: errors are now read, logged, and returned as proper error responses.

- **Antigravity JSON Schema Validation Errors**: Gemini's function declaration format doesn't support many JSON Schema fields that Claude Code's tools use (`exclusiveMinimum`, `propertyNames`, `additionalProperties`, `const`, `$ref`, etc.). The `cleanSchema()` function only stripped 2 fields at the top level. Gemini returned 400: `Unknown name "exclusiveMinimum"`. Fixed with recursive schema cleaning that strips 25+ unsupported fields from all nested property schemas, items, and combinators.

- **Bun `pipeThrough` Not Invoking TransformStream**: In Bun 1.x, `fetchResponse.body.pipeThrough(transformStream)` silently fails to invoke the transform callback — the stream appears to complete with 0 events processed. Replaced `pipeThrough` with manual reader/writer piping for the Antigravity converter: read upstream chunks with `getReader()`, write to the TransformStream's writable side with `getWriter()`, return the readable side.

- **Gemini Thought Signature Requirement**: Gemini 3 requires `thought_signature` on `functionCall` parts in conversation history ([docs](https://ai.google.dev/gemini-api/docs/thought-signatures)), but Anthropic `tool_use` blocks don't have these. Even with historical tool_use/tool_result converted to text, sending tool definitions (functionDeclarations) caused Gemini to infer function call context at position 38, triggering 400: "missing thought_signature". Fixed by stripping tools from Gemini requests entirely — tool_use/tool_result are already text representations, and Claude Code handles tool orchestration, not Gemini.

### Changed

- **Proxy Auth is Async**: `getProviderAuth()` now async to support OAuth token resolution via `getAccessToken()`. Returns `{ apiKey, baseUrl, providerType }` (was `{ apiKey, baseUrl }`).

- **Agent Reassignment**: Oracle default → OpenAI/gpt-5.2 (was Claude/sonnet-4.5), Frontend-UI-UX default → Google/gemini-3-flash (was ZhiPu/glm-4v-flash). Both retain original providers as fallback.

- **Sisyphus Routing**: Added Hephaestus to orchestration routing table and delegation list.

- **Category Fallback**: `resolveProviderForCategory()` now uses the same universal fallback chain as agents, so categories also degrade gracefully.

### New Files

- `src/auth/antigravity.ts` — Google OAuth PKCE flow with browser callback server
- `src/auth/codex.ts` — OpenAI OAuth PKCE + headless device code flow
- `src/auth/copilot.ts` — GitHub Copilot device code flow
- `src/auth/store.ts` — Encrypted credential store (AES-256-GCM)
- `src/auth/token-manager.ts` — Token lifecycle management with auto-refresh
- `src/auth/account-pool.ts` — Google multi-account quota rotation pool
- `src/auth/types.ts` — OAuth credential type definitions
- `src/providers/google.ts` — Google Gemini provider client (OpenAI-format API)
- `src/providers/openai-native.ts` — OpenAI native provider client
- `src/providers/copilot.ts` — GitHub Copilot provider client
- `src/proxy/antigravity-converter.ts` — Anthropic ↔ Google Antigravity (Gemini native) format converter + SSE stream transformer
- `src/proxy/responses-converter.ts` — Anthropic ↔ OpenAI Responses API format converter + SSE stream transformer
- `src/proxy/format-converter.ts` — Anthropic ↔ OpenAI Chat Completions format converter + SSE stream transformer
- `src/agents/hephaestus.ts` — Code forge specialist agent
- `src/commands/omc-hephaestus.md` — Hephaestus slash command
- `src/cli/commands/auth.ts` — Auth CLI command (login, logout, list, add-account)
- `docs/changelog/v2.0.x.md` — This changelog
